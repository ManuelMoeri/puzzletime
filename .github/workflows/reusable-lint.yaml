name: 'Code Style Review'

on:
  workflow_call:

jobs:
  lint:
    runs-on: 'ubuntu-latest'

    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true

    - name: 'Set up Reviewdog'
      env:
        REVIEWDOG_INSTALLER: 'https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh'
      run: |
        mkdir -p $HOME/bin
        curl -sfL ${REVIEWDOG_INSTALLER} | sh -s -- -b $HOME/bin

    - name: 'Set up Rubocop'
      run: 'gem install rubocop rubocop-minitest rubocop-performance rubocop-rails'

    - name: 'Run Rubocop'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        rubocop |
        $HOME/bin/reviewdog \
        -f=rubocop \
        -name="Rubocop" \
        -reporter=github-pr-review \
        -level=error \
        -diff="git diff $DIFF_BRANCH"

    - name: 'Set up Haml-lint'
      run: 'gem install haml-lint'

    - name: 'Run Haml-lint'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        haml-lint |
        $HOME/bin/reviewdog \
        -efm="%f:%l %m" \
        -name="Haml-lint" \
        -reporter=github-pr-review \
        -level=error \
        -diff="git diff $DIFF_BRANCH"
